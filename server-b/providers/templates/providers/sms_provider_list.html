<!-- server-b/providers/templates/providers/sms_provider_list.html -->
{% extends 'base.html' %}
{% load static %}

{% block extra_head %}
    <link rel="stylesheet" href="{% static 'css/dashboard.css' %}">
{% endblock extra_head %}

{% block content %}
<div class="container">
  <!-- Header -->
  <div class="header">
    <div>
      <h1 class="title">Provider Management</h1>
      <p class="subtitle">Create, edit and manage SMS providers.</p>
    </div>
    {% if user.is_staff %}
      <a class="btn btn-primary" href="{% url 'sms_provider_add' %}">Add Provider</a>
    {% endif %}
  </div>

  <!-- Card -->
  <section class="card">
    <div class="card__body">
      <div class="toolbar">
        <input class="input" placeholder="Search providers..." />
        <span class="subtitle">Total: {{ sms_providers|length }}</span>
      </div>

      <div class="table-wrap">
        <table>
          <thead>
            <tr>
              <th>Name</th>
              <th>Slug</th>
              <th>Auth Type</th>
              <th class="text-right">Priority</th>
              <th class="text-right">Status</th>
              <th class="text-right">Actions</th>
            </tr>
          </thead>
          <tbody>
          {% for sms_provider in sms_providers %}
            <tr>
              <td>{{ sms_provider.name }}</td>
              <td>{{ sms_provider.slug }}</td>
              <td>{{ sms_provider.get_auth_type_display }}</td>
              <td class="text-right">{{ sms_provider.priority }}</td>
              <td class="text-right">
                <span id="status-pill-{{ sms_provider.pk }}" class="pill {% if sms_provider.is_active %}pill--on{% else %}pill--off{% endif %}">
                  {% if sms_provider.is_active %}Active{% else %}Inactive{% endif %}
                </span>
              </td>
              <td class="text-right">
                <details class="relative ml-auto">
                  <summary class="btn btn-ghost h-8 w-24 flex items-center justify-center">Actions</summary>
                  <div class="absolute right-0 mt-2 w-48 bg-white rounded-md shadow-lg py-1 ring-1 ring-black ring-opacity-5 focus:outline-none z-10">
                    <a href="{% url 'sms_provider_edit' sms_provider.pk %}" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">Edit</a>
                    <a href="{% url 'sms_provider_delete' sms_provider.pk %}" class="block px-4 py-2 text-sm text-red-700 hover:bg-red-100">Delete</a>
                    <a href="#" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 check-balance-btn" data-provider-id="{{ sms_provider.pk }}">Check Balance</a>
                    <a href="{% url 'sms_provider_test' sms_provider.pk %}" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">Send Test SMS</a>
                    {% if sms_provider.is_active %}
                      <a href="#" class="block px-4 py-2 text-sm text-red-700 hover:bg-red-100 toggle-provider-status-btn" data-provider-id="{{ sms_provider.pk }}" data-is-active="false">Disable</a>
                    {% else %}
                      <a href="#" class="block px-4 py-2 text-sm text-green-700 hover:bg-green-100 toggle-provider-status-btn" data-provider-id="{{ sms_provider.pk }}" data-is-active="true">Enable</a>
                    {% endif %}
                  </div>
                </details>
              </td>
            </tr>
          {% empty %}
            <tr><td colspan="6">No providers yet.</td></tr>
          {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
  </section>
</div>
{% endblock content %}
<script src="{% static 'js/toastify-js.js' %}"></script>
<script>
  document.addEventListener('click', function(event) {
    document.querySelectorAll('details').forEach(function(detail) {
      if (!detail.contains(event.target)) {
        detail.removeAttribute('open');
      }
    });
  });

  // CSRF token setup for AJAX requests
  function getCookie(name) {
      let cookieValue = null;
      if (document.cookie && document.cookie !== '') {
          const cookies = document.cookie.split(';');
          for (let i = 0; i < cookies.length; i++) {
              const cookie = cookies[i].trim();
              // Does this cookie string begin with the name we want?
              if (cookie.substring(0, name.length + 1) === (name + '=')) {
                  cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                  break;
              }
          }
      }
      return cookieValue;
  }
  const csrftoken = getCookie('csrftoken');

  document.querySelectorAll('.toggle-provider-status-btn').forEach(function(button) {
      button.addEventListener('click', function(e) {
          e.preventDefault(); // Prevent default link behavior
          const providerId = this.dataset.providerId;
          const isActive = this.dataset.isActive === 'true'; // Convert string to boolean
          const statusPill = document.getElementById(`status-pill-${providerId}`);
          const actionMenu = this.closest('.absolute'); // Get the parent action menu div

          fetch(`{% url 'toggle_provider_status' 0 %}`.replace('0', providerId), {
              method: 'POST',
              headers: {
                  'Content-Type': 'application/json',
                  'X-CSRFToken': csrftoken
              },
              body: JSON.stringify({ is_active: isActive })
          })
          .then(response => response.json())
          .then(data => {
              if (data.success) {
                  // Update the pill text and class
                  if (data.is_active) {
                      statusPill.textContent = 'Active';
                      statusPill.classList.remove('pill--off');
                      statusPill.classList.add('pill--on');
                      Toastify({
                          text: "Provider activated successfully!",
                          duration: 3000,
                          close: true,
                          gravity: "top", // `top` or `bottom`
                          position: "right", // `left`, `center` or `right`
                          backgroundColor: "linear-gradient(to right, #00b09b, #96c93d)",
                      }).showToast();
                  } else {
                      statusPill.textContent = 'Inactive';
                      statusPill.classList.remove('pill--on');
                      statusPill.classList.add('pill--off');
                      Toastify({
                          text: "Provider deactivated successfully!",
                          duration: 3000,
                          close: true,
                          gravity: "top", // `top` or `bottom`
                          position: "right", // `left`, `center` or `right`
                          backgroundColor: "linear-gradient(to right, #ff5f6d, #ffc371)",
                      }).showToast();
                  }
                  // Update action menu buttons
                  const enableBtn = actionMenu.querySelector('[data-is-active="true"]');
                  const disableBtn = actionMenu.querySelector('[data-is-active="false"]');
                  if (data.is_active) {
                      if (enableBtn) enableBtn.style.display = 'none';
                      if (disableBtn) disableBtn.style.display = 'block';
                  } else {
                      if (enableBtn) enableBtn.style.display = 'block';
                      if (disableBtn) disableBtn.style.display = 'none';
                  }
              } else {
                  Toastify({
                      text: `Error: ${data.error}`,
                      duration: 3000,
                      close: true,
                      gravity: "top", // `top` or `bottom`
                      position: "right", // `left`, `center` or `right`
                      backgroundColor: "linear-gradient(to right, #ff416c, #ff4b2b)",
                  }).showToast();
              }
          })
          .catch(error => {
              console.error('Error:', error);
              Toastify({
                  text: "Network error. Please try again.",
                  duration: 3000,
                  close: true,
                  gravity: "top", // `top` or `bottom`
                  position: "right", // `left`, `center` or `right`
                  backgroundColor: "linear-gradient(to right, #ff416c, #ff4b2b)",
              }).showToast();
          });
      });
  });

  document.querySelectorAll('.check-balance-btn').forEach(function(button) {
    button.addEventListener('click', function(e) {
      e.preventDefault();
      const providerId = this.dataset.providerId;

      Toastify({
        text: "Checking balance...",
        duration: 2000,
        close: true,
        gravity: "top",
        position: "right",
        backgroundColor: "linear-gradient(to right, #00b09b, #96c93d)",
      }).showToast();

      fetch(`{% url 'check_balance' 0 %}`.replace('0', providerId))
        .then(response => response.json())
        .then(data => {
          if (data.error) {
            Toastify({
              text: `Error: ${data.error}`,
              duration: 3000,
              close: true,
              gravity: "top",
              position: "right",
              backgroundColor: "linear-gradient(to right, #ff416c, #ff4b2b)",
            }).showToast();
          } else {
            Toastify({
              text: `Balance: ${data.balance}`,
              duration: 3000,
              close: true,
              gravity: "top",
              position: "right",
              backgroundColor: "linear-gradient(to right, #00b09b, #96c93d)",
            }).showToast();
          }
        })
        .catch(error => {
          console.error('Error:', error);
          Toastify({
            text: "Error checking balance.",
            duration: 3000,
            close: true,
            gravity: "top",
            position: "right",
            backgroundColor: "linear-gradient(to right, #ff416c, #ff4b2b)",
          }).showToast();
        });
    });
  });
</script>

