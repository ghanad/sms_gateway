{% extends 'base.html' %}
{% load static %}

{% block extra_head %}
    <link rel="stylesheet" href="{% static 'css/dashboard.css' %}">
{% endblock extra_head %}

{% block content %}
    <div class="container">
        <!-- Header -->
        <div class="header">
            <div>
                <h1 class="title">User Management</h1>
                <p class="subtitle">Manage users and their access levels.</p>
            </div>
            <a href="{% url 'user_create' %}" class="btn btn-primary">Add user</a>
        </div>

        <!-- Card -->
        <section class="card">
            <div class="card__body">
                

                <!-- Table -->
                <div class="table-wrap">
                    <table>
                        <thead>
                            <tr>
                                <th>Username</th>
                                <th>Email</th>
                                <th>Is Staff</th>
                                <th>Is Active</th>
                                <th class="text-right">Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for user in users %}
                            <tr>
                                <td><strong>{{ user.username }}</strong></td>
                                <td>{{ user.email }}</td>
                                <td><span class="pill {% if user.is_staff %}pill--on{% else %}pill--off{% endif %}">{% if user.is_staff %}Yes{% else %}No{% endif %}</span></td>
                                <td><span class="pill {% if user.is_active %}pill--on{% else %}pill--off{% endif %}">{% if user.is_active %}Active{% else %}Inactive{% endif %}</span></td>
                                <td class="text-right">
                                    <details class="relative ml-auto">
                                        <summary class="btn btn-ghost h-8 w-24 flex items-center justify-center">Actions</summary>
                                        <div class="absolute right-0 mt-2 w-48 bg-white rounded-md shadow-lg py-1 ring-1 ring-black ring-opacity-5 focus:outline-none z-10">
                                            <a href="{% url 'user_update' user.pk %}" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">Edit</a>
                                            <a href="{% url 'user_delete' user.pk %}" class="block px-4 py-2 text-sm text-red-700 hover:bg-red-100">Delete</a>
                                            {% if user.is_active %}
                                                <a href="#" class="block px-4 py-2 text-sm text-red-700 hover:bg-red-100 toggle-user-status-btn" data-user-id="{{ user.pk }}" data-is-active="false">Disable</a>
                                            {% else %}
                                                <a href="#" class="block px-4 py-2 text-sm text-green-700 hover:bg-green-100 toggle-user-status-btn" data-user-id="{{ user.pk }}" data-is-active="true">Enable</a>
                                            {% endif %}
                                        </div>
                                    </details>
                                </td>
                            </tr>
                            {% empty %}
                            <tr>
                                <td colspan="5">No users found.</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </section>
    </div>

    <!-- Edit User Modal (CSS-only; same layout) -->
    <div id="editUser" class="modal" aria-hidden="true">
        <a class="modal__backdrop" href="#"></a>
        <div class="modal__panel" role="dialog" aria-modal="true" aria-labelledby="edit-user-title">
            <div class="panel" role="document">
                <div class="panel__header">
                    <div>
                        <h2 id="edit-user-title" style="margin:0;font-size:18px;font-weight:600;">Edit user</h2>
                        <p class="subtitle" style="margin-top:6px;">Update user details.</p>
                    </div>
                    <a class="close" href="#" aria-label="Close">Ã—</a>
                </div>

                <div class="panel__body">
                    <form action="" method="post"> {# Action will be set by JS or dynamically #}
                        {% csrf_token %}
                        <div class="grid">
                            {% for field in update_form %}
                                <div>
                                    <label class="label" for="{{ field.id_for_label }}">{{ field.label }}</label>
                                    {{ field }}
                                    {% if field.help_text %}
                                        <p class="subtitle">{{ field.help_text }}</p>
                                    {% endif %}
                                    {% for error in field.errors %}
                                        <p class="text-red-500 text-sm">{{ error }}</p>
                                    {% endfor %}
                                </div>
                            {% endfor %}
                        </div>
                        <div class="panel__footer">
                            <a class="btn" href="#">Cancel</a>
                            <button type="submit" class="btn btn-primary">Save changes</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
    <script src="{% static 'js/toastify-js.js' %}"></script>
    <script>
      document.addEventListener('click', function(event) {
        document.querySelectorAll('details').forEach(function(detail) {
          if (!detail.contains(event.target)) {
            detail.removeAttribute('open');
          }
        });
      });

      // CSRF token setup for AJAX requests
      function getCookie(name) {
          let cookieValue = null;
          if (document.cookie && document.cookie !== '') {
              const cookies = document.cookie.split(';');
              for (let i = 0; i < cookies.length; i++) {
                  const cookie = cookies[i].trim();
                  // Does this cookie string begin with the name we want?
                  if (cookie.substring(0, name.length + 1) === (name + '=')) {
                      cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                      break;
                  }
              }
          }
          return cookieValue;
      }
      const csrftoken = getCookie('csrftoken');

      document.querySelectorAll('.toggle-user-status-btn').forEach(function(button) {
          button.addEventListener('click', function(e) {
              e.preventDefault(); // Prevent default link behavior
              const userId = this.dataset.userId;
              const isActive = this.dataset.isActive === 'true'; // Convert string to boolean
              const statusPill = document.getElementById(`status-pill-${userId}`);
              const actionMenu = this.closest('.absolute'); // Get the parent action menu div

              fetch(`{% url 'user_toggle' 0 %}`.replace('0', userId), {
                  method: 'POST',
                  headers: {
                      'Content-Type': 'application/json',
                      'X-CSRFToken': csrftoken
                  },
                  body: JSON.stringify({ is_active: isActive })
              })
              .then(response => response.json())
              .then(data => {
                  if (data.success) {
                      // Update the pill text and class
                      if (data.is_active) {
                          statusPill.textContent = 'Active';
                          statusPill.classList.remove('pill--off');
                          statusPill.classList.add('pill--on');
                          Toastify({
                              text: "User activated successfully!",
                              duration: 3000,
                              close: true,
                              gravity: "top", // `top` or `bottom`
                              position: "right", // `left`, `center` or `right`
                              backgroundColor: "linear-gradient(to right, #00b09b, #96c93d)",
                          }).showToast();
                      } else {
                          statusPill.textContent = 'Inactive';
                          statusPill.classList.remove('pill--on');
                          statusPill.classList.add('pill--off');
                          Toastify({
                              text: "User deactivated successfully!",
                              duration: 3000,
                              close: true,
                              gravity: "top", // `top` or `bottom`
                              position: "right", // `left`, `center` or `right`
                              backgroundColor: "linear-gradient(to right, #ff5f6d, #ffc371)",
                          }).showToast();
                      }
                      // Update action menu buttons
                      const enableBtn = actionMenu.querySelector('[data-is-active="true"]');
                      const disableBtn = actionMenu.querySelector('[data-is-active="false"]');
                      if (data.is_active) {
                          if (enableBtn) enableBtn.style.display = 'none';
                          if (disableBtn) disableBtn.style.display = 'block';
                      } else {
                          if (enableBtn) enableBtn.style.display = 'block';
                          if (disableBtn) disableBtn.style.display = 'none';
                      }
                  } else {
                      Toastify({
                          text: `Error: ${data.error}`,
                          duration: 3000,
                          close: true,
                          gravity: "top", // `top` or `bottom`
                          position: "right", // `left`, `center` or `right`
                          backgroundColor: "linear-gradient(to right, #ff416c, #ff4b2b)",
                      }).showToast();
                  }
              })
              .catch(error => {
                  console.error('Error:', error);
                  Toastify({
                      text: "Network error. Please try again.",
                      duration: 3000,
                      close: true,
                      gravity: "top", // `top` or `bottom`
                      position: "right", // `left`, `center` or `right`
                      backgroundColor: "linear-gradient(to right, #ff416c, #ff4b2b)",
                  }).showToast();
              });
          });
      });
    </script>
{% endblock content %}
