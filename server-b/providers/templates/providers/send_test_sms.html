{% extends 'base.html' %}
{% load static %}

{% block extra_head %}
    <link rel="stylesheet" href="{% static 'css/dashboard.css' %}">
{% endblock extra_head %}

{% block content %}
<div class="container">
  <!-- Header -->
  <div class="header">
    <div>
      <h1 class="title">Send Test SMS</h1>
      <p class="subtitle">Send a test SMS using the provider: <strong>{{ provider.name }}</strong></p>
      <div class="flex items-center">
        <button id="check-balance-btn" class="btn btn-secondary">Check Balance</button>
        <p id="balance-display" class="ml-4"></p>
      </div>
    </div>
    <div>
      <a class="btn" href="{% url 'sms_provider_list' %}">Back to list</a>
    </div>
  </div>

  <!-- Card -->
  <section class="card">
    <div class="card__body">
      <form method="post">
        {% csrf_token %}
        {{ form.as_p }}
        <div class="panel__footer">
          <button type="submit" class="btn btn-primary">Send Test SMS</button>
        </div>
      </form>

      {% if result %}
      <div class="mt-4">
        <h2 class="text-lg font-semibold">Result</h2>
        {% if result.error %}
          <div class="alert alert-danger">
            <p><strong>Error:</strong> {{ result.error }}</p>
          </div>
        {% else %}
          <div class="alert alert-success">
            <p><strong>Success!</strong></p>
          </div>
          <pre class="mt-2 p-2 bg-gray-100 rounded">{{ result|json_script:"result-json" }}</pre>
          <script>
            const resultData = JSON.parse(document.getElementById('result-json').textContent);
            document.querySelector('pre').textContent = JSON.stringify(resultData, null, 2);
          </script>
        {% endif %}
      </div>
      {% endif %}
    </div>
  </section>
</div>
{% endblock content %}
<script>
  document.getElementById('check-balance-btn').addEventListener('click', function() {
    const providerId = {{ provider.pk }};
    const balanceDisplay = document.getElementById('balance-display');
    balanceDisplay.textContent = 'Checking...';

    fetch(`{% url 'check_balance' 0 %}`.replace('0', providerId))
      .then(response => response.json())
      .then(data => {
        if (data.error) {
          balanceDisplay.textContent = `Error: ${data.error}`;
        } else {
          balanceDisplay.textContent = `Balance: ${data.balance}`;
        }
      })
      .catch(error => {
        console.error('Error:', error);
        balanceDisplay.textContent = 'Error checking balance.';
      });
  });
</script>
